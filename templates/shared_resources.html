<!-- Recursos compartilhados para todas as páginas do funil -->

<!-- Meta tags básicas -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<!-- CSS compartilhados -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/caixa-fonts.css') }}">

<!-- Rastreadores UTM e integração com Utmify -->
<script src="{{ url_for('static', filename='js/utm_tracker.js') }}"></script>
<script src="{{ url_for('static', filename='js/utmify_helper.js') }}"></script>

<!-- Script para capturar parâmetros UTM e propagá-los entre páginas -->
<script>
  // Função para obter parâmetros da URL
  function getUrlParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    const params = {};
    
    for (const [key, value] of urlParams.entries()) {
      params[key] = value;
    }
    
    return params;
  }
  
  // Função para salvar parâmetros no localStorage
  function saveParameters() {
    const params = getUrlParameters();
    
    // Salvar todos os parâmetros no localStorage
    if (Object.keys(params).length > 0) {
      localStorage.setItem('allUrlParams', JSON.stringify(params));
      console.log('Parâmetros salvos:', params);
    }
  }
  
  // Função para adicionar parâmetros UTM a uma URL
  function appendUrlParams(url, extraParams = {}) {
    // Obter parâmetros armazenados
    let params = {};
    
    const storedParams = localStorage.getItem('allUrlParams');
    if (storedParams) {
      try {
        params = JSON.parse(storedParams);
      } catch(e) {
        console.error('Erro ao analisar parâmetros armazenados:', e);
      }
    }
    
    // Mesclar com os parâmetros extras fornecidos
    params = {...params, ...extraParams};
    
    // Se não há parâmetros, retorna a URL original
    if (Object.keys(params).length === 0) {
      return url;
    }
    
    // Criar URL Search Params para construir a string de consulta
    const urlSearchParams = new URLSearchParams();
    for (const [key, value] of Object.entries(params)) {
      if (value) {
        urlSearchParams.append(key, value);
      }
    }
    
    // Adicionar os parâmetros à URL
    const separator = url.includes('?') ? '&' : '?';
    return url + separator + urlSearchParams.toString();
  }
  
  // Função para redirecionar preservando parâmetros UTM
  function redirectWithUtm(url, extraParams = {}) {
    window.location.href = appendUrlParams(url, extraParams);
  }

  // Executar quando o DOM estiver carregado
  document.addEventListener('DOMContentLoaded', function() {
    // Salvar parâmetros da URL atual
    saveParameters();
    
    // Adicionar parâmetros UTM a todos os links na página
    const links = document.querySelectorAll('a:not([data-no-utm])');
    links.forEach(link => {
      const href = link.getAttribute('href');
      if (href && !href.startsWith('#') && !href.startsWith('javascript:') && !href.startsWith('tel:') && !href.startsWith('mailto:')) {
        link.setAttribute('href', appendUrlParams(href));
      }
    });
    
    // Adicionar parâmetros UTM a todos os formulários na página
    const forms = document.querySelectorAll('form:not([data-no-utm])');
    forms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const params = JSON.parse(localStorage.getItem('allUrlParams') || '{}');
        
        // Para cada parâmetro UTM, adicionar um campo oculto ao formulário
        for (const [key, value] of Object.entries(params)) {
          // Verificar se já existe um campo para este parâmetro
          let input = form.querySelector(`input[name="${key}"]`);
          
          if (!input && value) {
            // Se não existir, criar um novo campo oculto
            input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            form.appendChild(input);
          }
          
          if (input && value) {
            input.value = value;
          }
        }
      });
    });
  });
</script>

<!-- Funções utilitárias compartilhadas -->
<script>
  // Função para validar CPF
  function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]/g, ''); // Remove caracteres não numéricos
    
    if (cpf.length !== 11) return false;
    
    // Verifica se todos os dígitos são iguais
    if (/^(\d)\1+$/.test(cpf)) return false;
    
    // Validação dos dígitos verificadores
    let soma = 0;
    let resto;
    
    for (let i = 1; i <= 9; i++) {
      soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
    }
    
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(9, 10))) return false;
    
    soma = 0;
    for (let i = 1; i <= 10; i++) {
      soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
    }
    
    resto = (soma * 10) % 11;
    if (resto === 10 || resto === 11) resto = 0;
    if (resto !== parseInt(cpf.substring(10, 11))) return false;
    
    return true;
  }
  
  // Formatação de CPF
  function formatarCPF(cpf) {
    cpf = cpf.replace(/[^\d]/g, '');
    return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
  }
  
  // Formatação de telefone
  function formatarTelefone(telefone) {
    telefone = telefone.replace(/[^\d]/g, '');
    if (telefone.length === 11) {
      return telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
    } else if (telefone.length === 10) {
      return telefone.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
    }
    return telefone;
  }
  
  // Função para mostrar mensagem de erro
  function mostrarErro(mensagem, elementoId = 'mensagem-erro') {
    const elemento = document.getElementById(elementoId);
    if (elemento) {
      elemento.textContent = mensagem;
      elemento.style.display = 'block';
      setTimeout(() => {
        elemento.style.display = 'none';
      }, 5000);
    } else {
      alert(mensagem);
    }
  }
  
  // Função para mostrar mensagem de sucesso
  function mostrarSucesso(mensagem, elementoId = 'mensagem-sucesso') {
    const elemento = document.getElementById(elementoId);
    if (elemento) {
      elemento.textContent = mensagem;
      elemento.style.display = 'block';
      setTimeout(() => {
        elemento.style.display = 'none';
      }, 5000);
    }
  }
</script>

<!-- Inclusão condicional do Google Tag Manager (se definido) -->
{% if config.get('GTM_ID') %}
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','{{ config.get("GTM_ID") }}');</script>
{% endif %}

<!-- Inclusão condicional do Facebook Pixel (se definido) -->
{% if config.get('FB_PIXEL_ID') %}
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '{{ config.get("FB_PIXEL_ID") }}');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id={{ config.get('FB_PIXEL_ID') }}&ev=PageView&noscript=1"
/></noscript>
{% endif %}