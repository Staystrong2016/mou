<!-- Componente de Depuração para Facebook Conversion API -->
<div id="fb-debug-container" class="fixed bottom-0 right-0 w-96 max-h-96 bg-white border border-gray-300 shadow-lg rounded-tl-md overflow-hidden z-50" style="display: none;">
  <div class="bg-blue-600 text-white px-4 py-2 flex justify-between items-center cursor-pointer" id="fb-debug-header">
    <h3 class="text-sm font-semibold">Facebook Conversion API Debug</h3>
    <div class="flex space-x-2">
      <button id="fb-debug-clear" class="text-xs bg-blue-700 hover:bg-blue-800 px-2 py-1 rounded">Limpar</button>
      <button id="fb-debug-minimize" class="text-xs bg-blue-700 hover:bg-blue-800 px-2 py-1 rounded">_</button>
      <button id="fb-debug-close" class="text-xs bg-red-600 hover:bg-red-700 px-2 py-1 rounded">×</button>
    </div>
  </div>
  <div class="overflow-y-auto p-4 max-h-80 bg-gray-50" id="fb-debug-content">
    <div class="text-xs text-gray-500 mb-2">Aguardando eventos...</div>
  </div>
</div>

<style>
  #fb-debug-container {
    font-family: monospace;
    font-size: 12px;
    transition: all 0.3s ease;
  }
  #fb-debug-container.minimized {
    height: 32px;
    overflow: hidden;
  }
  .fb-event-entry {
    margin-bottom: 8px;
    padding: 8px;
    border-radius: 4px;
    border-left: 3px solid #4f46e5;
    background-color: #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  }
  .fb-event-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
    font-weight: bold;
    color: #4f46e5;
  }
  .fb-event-data {
    margin-top: 4px;
    padding: 4px;
    background-color: #f9fafb;
    border-radius: 2px;
    overflow-x: auto;
  }
  .fb-event-param {
    margin-top: 2px;
    color: #374151;
  }
  .fb-event-param-key {
    color: #4b5563;
    font-weight: 600;
  }
  .fb-event-param-value {
    color: #1f2937;
  }
  .fb-event-success {
    border-left-color: #22c55e;
  }
  .fb-event-success .fb-event-header {
    color: #16a34a;
  }
  .fb-event-error {
    border-left-color: #ef4444;
  }
  .fb-event-error .fb-event-header {
    color: #dc2626;
  }
</style>

<script>
// Inicialização do depurador do Facebook Pixel
document.addEventListener('DOMContentLoaded', function() {
  const container = document.getElementById('fb-debug-container');
  const header = document.getElementById('fb-debug-header');
  const content = document.getElementById('fb-debug-content');
  const minimizeBtn = document.getElementById('fb-debug-minimize');
  const closeBtn = document.getElementById('fb-debug-close');
  const clearBtn = document.getElementById('fb-debug-clear');
  
  // Verificar se o depurador deve estar visível (baseado em localStorage)
  const debuggerVisible = localStorage.getItem('fb_debugger_visible') === 'true';
  const debuggerMinimized = localStorage.getItem('fb_debugger_minimized') === 'true';
  
  if (debuggerVisible) {
    container.style.display = 'block';
    if (debuggerMinimized) {
      container.classList.add('minimized');
    }
  }
  
  // Toggle visibilidade ao clicar no header
  header.addEventListener('click', function(e) {
    if (e.target === header) {
      container.classList.toggle('minimized');
      localStorage.setItem('fb_debugger_minimized', container.classList.contains('minimized'));
    }
  });
  
  // Botão de minimizar
  minimizeBtn.addEventListener('click', function() {
    container.classList.toggle('minimized');
    localStorage.setItem('fb_debugger_minimized', container.classList.contains('minimized'));
  });
  
  // Botão de fechar
  closeBtn.addEventListener('click', function() {
    container.style.display = 'none';
    localStorage.setItem('fb_debugger_visible', 'false');
  });
  
  // Botão de limpar
  clearBtn.addEventListener('click', function() {
    content.innerHTML = '<div class="text-xs text-gray-500 mb-2">Logs limpos. Aguardando eventos...</div>';
  });
  
  // Tecla de atalho para mostrar/esconder o depurador (Ctrl+Shift+F)
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'F') {
      container.style.display = container.style.display === 'none' ? 'block' : 'none';
      localStorage.setItem('fb_debugger_visible', container.style.display === 'block');
      e.preventDefault();
    }
  });
  
  // Interceptar eventos do Facebook Pixel
  // Criar um listener global para eventos de conversão do Facebook
  window.addEventListener('fb_conversion_api_event', function(e) {
    logFacebookEvent(e.detail);
  });
  
  // Função para formatar e exibir eventos do Facebook no depurador
  function logFacebookEvent(eventData) {
    const timestamp = new Date().toLocaleTimeString();
    const isSuccess = eventData.success === true;
    const eventName = eventData.eventName || 'Evento Desconhecido';
    
    // Criar elemento de entrada de log
    const eventEntry = document.createElement('div');
    eventEntry.className = `fb-event-entry ${isSuccess ? 'fb-event-success' : 'fb-event-error'}`;
    
    // Cabeçalho do evento
    const eventHeader = document.createElement('div');
    eventHeader.className = 'fb-event-header';
    eventHeader.innerHTML = `
      <span>${eventName}</span>
      <span>${timestamp}</span>
    `;
    
    // Conteúdo do evento
    let eventContent = '';
    
    // Adicionar status e mensagem
    eventContent += `<div class="fb-event-param">
      <span class="fb-event-param-key">Status:</span> 
      <span class="fb-event-param-value">${isSuccess ? 'Sucesso' : 'Erro'}</span>
    </div>`;
    
    if (eventData.message) {
      eventContent += `<div class="fb-event-param">
        <span class="fb-event-param-key">Mensagem:</span> 
        <span class="fb-event-param-value">${eventData.message}</span>
      </div>`;
    }
    
    // Adicionar ID do evento
    if (eventData.eventId) {
      eventContent += `<div class="fb-event-param">
        <span class="fb-event-param-key">Event ID:</span> 
        <span class="fb-event-param-value">${eventData.eventId}</span>
      </div>`;
    }
    
    // Adicionar URL da fonte do evento
    if (eventData.eventSourceUrl) {
      eventContent += `<div class="fb-event-param">
        <span class="fb-event-param-key">URL:</span> 
        <span class="fb-event-param-value">${eventData.eventSourceUrl}</span>
      </div>`;
    }
    
    // Adicionar parâmetros UTM
    if (eventData.utmParams && Object.keys(eventData.utmParams).length > 0) {
      eventContent += `<div class="fb-event-param">
        <span class="fb-event-param-key">Parâmetros UTM:</span>
      </div>`;
      
      Object.entries(eventData.utmParams).forEach(([key, value]) => {
        eventContent += `<div class="fb-event-param ml-4">
          <span class="fb-event-param-key">${key}:</span> 
          <span class="fb-event-param-value">${value}</span>
        </div>`;
      });
    }
    
    // Adicionar dados personalizados
    if (eventData.customData && Object.keys(eventData.customData).length > 0) {
      eventContent += `<div class="fb-event-param">
        <span class="fb-event-param-key">Dados Personalizados:</span>
      </div>`;
      
      Object.entries(eventData.customData).forEach(([key, value]) => {
        eventContent += `<div class="fb-event-param ml-4">
          <span class="fb-event-param-key">${key}:</span> 
          <span class="fb-event-param-value">${typeof value === 'object' ? JSON.stringify(value) : value}</span>
        </div>`;
      });
    }
    
    // Dados completos do evento (expandível)
    eventContent += `<div class="fb-event-data mt-2">
      <details>
        <summary class="cursor-pointer text-xs text-blue-600">Ver dados completos do evento</summary>
        <pre class="mt-2 text-xs overflow-x-auto">${JSON.stringify(eventData, null, 2)}</pre>
      </details>
    </div>`;
    
    // Adicionar conteúdo ao elemento
    const eventContentDiv = document.createElement('div');
    eventContentDiv.innerHTML = eventContent;
    
    // Montar a entrada de log
    eventEntry.appendChild(eventHeader);
    eventEntry.appendChild(eventContentDiv);
    
    // Adicionar ao container
    content.prepend(eventEntry);
    
    // Limitar o número de entradas (manter apenas as últimas 20)
    const entries = content.querySelectorAll('.fb-event-entry');
    if (entries.length > 20) {
      for (let i = 20; i < entries.length; i++) {
        entries[i].remove();
      }
    }
  }
});
</script>